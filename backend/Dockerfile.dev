FROM node:20-bookworm-slim

WORKDIR /app

# System deps (kept minimal). Prisma + pg + GCS work fine on Debian slim.
RUN apt-get update \
  && apt-get install -y --no-install-recommends ca-certificates openssl \
  && rm -rf /var/lib/apt/lists/*

# Install dependencies first (better layer caching)
COPY package.json pnpm-lock.yaml ./

# Use pnpm to match the repo lockfile
RUN corepack enable && pnpm install --frozen-lockfile

# Copy source (in compose we will bind-mount, but keeping this allows building the image standalone)
COPY . .

# Default dev port (Fastify CLI will be configured in compose command)
EXPOSE 8080

CMD ["bash", "-lc", "pnpm -s build:ts && pnpm -s dev"]


